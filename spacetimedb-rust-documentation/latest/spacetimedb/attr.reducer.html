<!DOCTYPE html><html lang="en">
<!-- Mirrored from docs.rs/spacetimedb/latest/spacetimedb/attr.reducer.html by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 10 May 2025 00:22:25 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Marks a function as a spacetimedb reducer."><title>reducer in spacetimedb - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="/-/rustdoc.static/${f}">`).join(""))</script><link rel="stylesheet" href="../../../-/rustdoc.static/normalize-9960930a.css"><link rel="stylesheet" href="../../../-/static/vendored80a2.css?0-6-0-f7595057-2025-05-09" media="all" /><link rel="stylesheet" href="../../../-/rustdoc.static/rustdoc-1a91846b.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="/-/rustdoc.static/" data-current-crate="spacetimedb" data-themes="" data-resource-suffix="-20250508-1.88.0-nightly-50aa04180" data-rustdoc-version="1.88.0-nightly (50aa04180 2025-05-08)" data-channel="nightly" data-search-js="search-f7877310.js" data-settings-js="settings-5514c975.js" ><script src="../../../-/rustdoc.static/storage-4e99c027.js"></script><script defer src="sidebar-items-20250508-1.88.0-nightly-50aa04180.js"></script><script defer src="../../../-/rustdoc.static/main-7ef8a74a.js"></script><noscript><link rel="stylesheet" href="../../../-/rustdoc.static/noscript-893ab5e7.css"></noscript><link rel="alternate icon" type="image/png" href="../../../-/rustdoc.static/favicon-32x32-6580c154.png"><link rel="icon" type="image/svg+xml" href="https://docs.rs/-/rustdoc.static/favicon-044be391.svg"><link rel="stylesheet" href="../../../-/static/rustdoc-2021-12-0580a2.css?0-6-0-f7595057-2025-05-09" media="all" /><link rel="stylesheet" href="../../../-/static/font-awesome80a2.css?0-6-0-f7595057-2025-05-09" media="all" />

        <link rel="search" href="https://docs.rs/-/static/opensearch.xml" type="application/opensearchdescription+xml" title="Docs.rs" />

        <script type="text/javascript">(function() {
    function applyTheme(theme) {
        if (theme) {
            document.documentElement.dataset.docsRsTheme = theme;
        }
    }

    window.addEventListener("storage", ev => {
        if (ev.key === "rustdoc-theme") {
            applyTheme(ev.newValue);
        }
    });

    // see ./storage-change-detection.html for details
    window.addEventListener("message", ev => {
        if (ev.data && ev.data.storage && ev.data.storage.key === "rustdoc-theme") {
            applyTheme(ev.data.storage.value);
        }
    });

    applyTheme(window.localStorage.getItem("rustdoc-theme"));
})();</script></head><body class="rustdoc-page">
<div class="nav-container">
    <div class="container">
        <div class="pure-menu pure-menu-horizontal" role="navigation" aria-label="Main navigation">
            <form action="https://docs.rs/releases/search"
                  method="GET"
                  id="nav-search-form"
                  class="landing-search-form-nav  ">

                
                <a href="https://docs.rs/" class="pure-menu-heading pure-menu-link docsrs-logo" aria-label="Docs.rs">
                    <span title="Docs.rs"><span class="fa fa-solid fa-cubes " aria-hidden="true"></span></span>
                    <span class="title">Docs.rs</span>
                </a><ul class="pure-menu-list">
    <script id="crate-metadata" type="application/json">
        
        {
            "name": "spacetimedb",
            "version": "1.1.2"
        }
    </script><li class="pure-menu-item pure-menu-has-children">
            <a href="#" class="pure-menu-link crate-name" title="Easy support for interacting between SpacetimeDB and Rust.">
                <span class="fa fa-solid fa-cube " aria-hidden="true"></span>
                <span class="title">spacetimedb-1.1.2</span>
            </a><div class="pure-menu-children package-details-menu">
                
                <ul class="pure-menu-list menu-item-divided">
                    <li class="pure-menu-heading" id="crate-title">
                        spacetimedb 1.1.2
                        <span id="clipboard" class="svg-clipboard" title="Copy crate name and version information"></span>
                    </li><li class="pure-menu-item">
                        <a href="../../1.1.2/spacetimedb/attr.reducer.html" class="pure-menu-link description" id="permalink" title="Get a link to this specific version">
                            <span class="fa fa-solid fa-link " aria-hidden="true"></span> Permalink
                        </a>
                    </li><li class="pure-menu-item">
                        <a href="https://docs.rs/crate/spacetimedb/latest" class="pure-menu-link description" title="See spacetimedb in docs.rs">
                            <span class="fa fa-solid fa-cube " aria-hidden="true"></span> Docs.rs crate page
                        </a>
                    </li></ul>

                <div class="pure-g menu-item-divided">
                    <div class="pure-u-1-2 right-border">
                        <ul class="pure-menu-list">
                            <li class="pure-menu-heading">Links</li>

                            <li class="pure-menu-item">
                                <a href="https://crates.io/crates/spacetimedb" class="pure-menu-link" title="See spacetimedb in crates.io">
                                    <span class="fa fa-solid fa-cube " aria-hidden="true"></span> crates.io
                                </a>
                            </li>

                            
                            <li class="pure-menu-item">
                                <a href="https://docs.rs/crate/spacetimedb/latest/source/" title="Browse source of spacetimedb-1.1.2" class="pure-menu-link">
                                    <span class="fa fa-solid fa-folder-open " aria-hidden="true"></span> Source
                                </a>
                            </li>
                        </ul>
                    </div><div class="pure-u-1-2">
                        <ul class="pure-menu-list" id="topbar-owners">
                            <li class="pure-menu-heading">Owners</li><li class="pure-menu-item">
                                    <a href="https://crates.io/users/cloutiertyler" class="pure-menu-link">
                                        <span class="fa fa-solid fa-user " aria-hidden="true"></span> cloutiertyler
                                    </a>
                                </li><li class="pure-menu-item">
                                    <a href="https://crates.io/users/jdetter" class="pure-menu-link">
                                        <span class="fa fa-solid fa-user " aria-hidden="true"></span> jdetter
                                    </a>
                                </li><li class="pure-menu-item">
                                    <a href="https://crates.io/users/bfops" class="pure-menu-link">
                                        <span class="fa fa-solid fa-user " aria-hidden="true"></span> bfops
                                    </a>
                                </li></ul>
                    </div>
                </div>

                <div class="pure-g menu-item-divided">
                    <div class="pure-u-1-2 right-border">
                        <ul class="pure-menu-list">
                            <li class="pure-menu-heading">Dependencies</li>

                            
                            <li class="pure-menu-item">
                                <div class="pure-menu pure-menu-scrollable sub-menu" tabindex="-1">
                                    <ul class="pure-menu-list">
                                        
    <li class="pure-menu-item"><a href="https://docs.rs/bytemuck/^1.16.2" class="pure-menu-link">
                        bytemuck ^1.16.2
                        
                            <i class="dependencies normal">normal</i>
                            
                        
                    </a>
                </li>
            <li class="pure-menu-item"><a href="https://docs.rs/derive_more/^0.99" class="pure-menu-link">
                        derive_more ^0.99
                        
                            <i class="dependencies normal">normal</i>
                            
                        
                    </a>
                </li>
            <li class="pure-menu-item"><a href="https://docs.rs/getrandom/^0.2" class="pure-menu-link">
                        getrandom ^0.2
                        
                            <i class="dependencies normal">normal</i>
                            
                                <i>optional</i>
                            
                        
                    </a>
                </li>
            <li class="pure-menu-item"><a href="https://docs.rs/log/^0.4.17" class="pure-menu-link">
                        log ^0.4.17
                        
                            <i class="dependencies normal">normal</i>
                            
                        
                    </a>
                </li>
            <li class="pure-menu-item"><a href="https://docs.rs/rand/^0.8" class="pure-menu-link">
                        rand ^0.8
                        
                            <i class="dependencies normal">normal</i>
                            
                                <i>optional</i>
                            
                        
                    </a>
                </li>
            <li class="pure-menu-item"><a href="https://docs.rs/scoped-tls/^1.0.1" class="pure-menu-link">
                        scoped-tls ^1.0.1
                        
                            <i class="dependencies normal">normal</i>
                            
                        
                    </a>
                </li>
            <li class="pure-menu-item"><a href="https://docs.rs/spacetimedb-bindings-macro/^1.1.2" class="pure-menu-link">
                        spacetimedb-bindings-macro ^1.1.2
                        
                            <i class="dependencies normal">normal</i>
                            
                        
                    </a>
                </li>
            <li class="pure-menu-item"><a href="https://docs.rs/spacetimedb-bindings-sys/^1.1.2" class="pure-menu-link">
                        spacetimedb-bindings-sys ^1.1.2
                        
                            <i class="dependencies normal">normal</i>
                            
                        
                    </a>
                </li>
            <li class="pure-menu-item"><a href="https://docs.rs/spacetimedb-lib/^1.1.2" class="pure-menu-link">
                        spacetimedb-lib ^1.1.2
                        
                            <i class="dependencies normal">normal</i>
                            
                        
                    </a>
                </li>
            <li class="pure-menu-item"><a href="https://docs.rs/spacetimedb-primitives/^1.1.2" class="pure-menu-link">
                        spacetimedb-primitives ^1.1.2
                        
                            <i class="dependencies normal">normal</i>
                            
                        
                    </a>
                </li>
            <li class="pure-menu-item"><a href="https://docs.rs/insta/^1.21.0" class="pure-menu-link">
                        insta ^1.21.0
                        
                            <i class="dependencies dev">dev</i>
                            
                        
                    </a>
                </li>
            <li class="pure-menu-item"><a href="https://docs.rs/trybuild/^1" class="pure-menu-link">
                        trybuild ^1
                        
                            <i class="dependencies dev">dev</i>
                            
                        
                    </a>
                </li>
            

                                    </ul>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <div class="pure-u-1-2">
                        <ul class="pure-menu-list">
                            <li class="pure-menu-heading">Versions</li>

                            <li class="pure-menu-item">
                                <div class="pure-menu pure-menu-scrollable sub-menu" id="releases-list" tabindex="-1" data-url="/crate/spacetimedb/latest/menus/releases/x86_64-unknown-linux-gnu/spacetimedb/attr.reducer.html">
                                    <span class="rotate"><span class="fa fa-solid fa-spinner " aria-hidden="true"></span></span>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
                    
                    
                    <div class="pure-g">
                        <div class="pure-u-1">
                            <ul class="pure-menu-list">
                                <li>
                                    <a href="https://docs.rs/crate/spacetimedb/latest" class="pure-menu-link">
                                        <b>87.88%</b>
                                        of the crate is documented
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div></div>
        </li><li class="pure-menu-item pure-menu-has-children">
                <a href="#" class="pure-menu-link" aria-label="Platform">
                    <span class="fa fa-solid fa-gears " aria-hidden="true"></span>
                    <span class="title">Platform</span>
                </a>

                
                <ul class="pure-menu-children" id="platforms" data-url="/crate/spacetimedb/latest/menus/platforms/x86_64-unknown-linux-gnu/spacetimedb/attr.reducer.html"><li class="pure-menu-item">
            <a href="https://docs.rs/crate/spacetimedb/latest/target-redirect/i686-pc-windows-msvc/spacetimedb/attr.reducer.html" class="pure-menu-link" data-fragment="retain" rel="nofollow">i686-pc-windows-msvc</a>
        </li><li class="pure-menu-item">
            <a href="https://docs.rs/crate/spacetimedb/latest/target-redirect/i686-unknown-linux-gnu/spacetimedb/attr.reducer.html" class="pure-menu-link" data-fragment="retain" rel="nofollow">i686-unknown-linux-gnu</a>
        </li><li class="pure-menu-item">
            <a href="https://docs.rs/crate/spacetimedb/latest/target-redirect/x86_64-unknown-linux-gnu/spacetimedb/attr.reducer.html" class="pure-menu-link current" data-fragment="retain" rel="nofollow">x86_64-unknown-linux-gnu</a>
        </li></ul>
            </li><li class="pure-menu-item">
                <a href="https://docs.rs/crate/spacetimedb/latest/features" title="Browse available feature flags of spacetimedb-1.1.2" class="pure-menu-link">
                    <span class="fa fa-solid fa-flag " aria-hidden="true"></span>
                    <span class="title">Feature flags</span>
                </a>
            </li>
        
    
</ul><div class="spacer"></div>
                
                

<ul class="pure-menu-list">
                    <li class="pure-menu-item pure-menu-has-children">
                        <a href="#" class="pure-menu-link" aria-label="Rust">Rust</a>
                        <ul class="pure-menu-children">
                            
    <li class="pure-menu-item">
        <a class="pure-menu-link" href="https://docs.rs/about" >
            About docs.rs
        </a>
    </li>

                            
    <li class="pure-menu-item">
        <a class="pure-menu-link" href="https://foundation.rust-lang.org/policies/privacy-policy/#docs.rs" target="_blank">
            Privacy policy
        </a>
    </li>

                            
    <li class="pure-menu-item">
        <a class="pure-menu-link" href="https://www.rust-lang.org/" target="_blank">
            Rust website
        </a>
    </li>

                            
    <li class="pure-menu-item">
        <a class="pure-menu-link" href="https://doc.rust-lang.org/book/" target="_blank">
            The Book
        </a>
    </li>


                            
    <li class="pure-menu-item">
        <a class="pure-menu-link" href="https://doc.rust-lang.org/std/" target="_blank">
            Standard Library API Reference
        </a>
    </li>


                            
    <li class="pure-menu-item">
        <a class="pure-menu-link" href="https://doc.rust-lang.org/rust-by-example/" target="_blank">
            Rust by Example
        </a>
    </li>


                            
    <li class="pure-menu-item">
        <a class="pure-menu-link" href="https://doc.rust-lang.org/cargo/guide/" target="_blank">
            The Cargo Guide
        </a>
    </li>


                            
    <li class="pure-menu-item">
        <a class="pure-menu-link" href="https://doc.rust-lang.org/nightly/clippy" target="_blank">
            Clippy Documentation
        </a>
    </li>

                        </ul>
                    </li>
                </ul>
                
                <div id="search-input-nav">
                    <label for="nav-search">
                        <span class="fa fa-solid fa-magnifying-glass " aria-hidden="true"></span>
                    </label>

                    
                    
                    <input id="nav-search" name="query" type="text" aria-label="Find crate by search query" tabindex="-1"
                        placeholder="Find crate"
                        >
                </div>
            </form>
        </div>
    </div>
</div><div class="rustdoc attr container-rustdoc" id="rustdoc_body_wrapper" tabindex="-1"><script async src="../../../-/static/menu80a2.js?0-6-0-f7595057-2025-05-09"></script>
<script async src="../../../-/static/index80a2.js?0-6-0-f7595057-2025-05-09"></script>

<iframe src="https://docs.rs/-/storage-change-detection.html" width="0" height="0" style="display: none"></iframe><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="index-2.html">spacetimedb</a><span class="version">1.1.2</span></h2></div><div class="sidebar-elems"><section id="rustdoc-toc"><h2 class="location"><a href="#">reducer</a></h2><h3><a href="#">Sections</a></h3><ul class="block top-toc"><li><a href="#lifecycle-reducers" title="Lifecycle Reducers">Lifecycle Reducers</a><ul><li><a href="#the-init-reducer" title="The `init` reducer">The <code>init</code> reducer</a></li><li><a href="#the-client_connected-reducer" title="The `client_connected` reducer">The <code>client_connected</code> reducer</a></li><li><a href="#the-client_disconnected-reducer" title="The `client_disconnected` reducer">The <code>client_disconnected</code> reducer</a></li></ul></li><li><a href="#scheduled-reducers" title="Scheduled reducers">Scheduled reducers</a><ul><li><a href="#restricting-scheduled-reducers" title="Restricting scheduled reducers">Restricting scheduled reducers</a></li></ul></li></ul></section><div id="rustdoc-modnav"><h2 class="in-crate"><a href="index-2.html">In crate spacetimedb</a></h2></div></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><div class="rustdoc-breadcrumbs"><a href="index-2.html">spacetimedb</a></div><h1>Attribute Macro <span class="attr">reducer</span><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="https://docs.rs/spacetimedb-bindings-macro/1.1.2/x86_64-unknown-linux-gnu/src/spacetimedb_bindings_macro/lib.rs.html#107">Source</a> </span></div><pre class="rust item-decl"><code>#[reducer]</code></pre><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Marks a function as a spacetimedb reducer.</p>
<p>A reducer is a function with read/write access to the database
that can be invoked remotely by <a href="https://spacetimedb.com/docs/#client">clients</a>.</p>
<p>Each reducer call runs in its own database transaction,
and its updates to the database are only committed if the reducer returns successfully.</p>
<p>The first argument of a reducer is always a <a href="struct.ReducerContext.html" title="struct spacetimedb::ReducerContext"><code>&amp;ReducerContext</code></a>. This context object
allows accessing the database and viewing information about the caller, among other things.</p>
<p>After this, a reducer can take any number of arguments.
These arguments must implement the <a href="trait.SpacetimeType.html" title="trait spacetimedb::SpacetimeType"><code>SpacetimeType</code></a>, <a href="trait.Serialize.html" title="trait spacetimedb::Serialize"><code>Serialize</code></a>, and <a href="trait.Deserialize.html" title="trait spacetimedb::Deserialize"><code>Deserialize</code></a> traits.
All of these traits can be derived at once by marking a type with <code>#[derive(SpacetimeType)]</code>.</p>
<p>Reducers may return either <code>()</code> or <code>Result&lt;(), E&gt;</code> where <a href="https://doc.rust-lang.org/nightly/core/fmt/trait.Display.html" title="trait core::fmt::Display"><code>E: std::fmt::Display</code></a>.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>spacetimedb::{reducer, SpacetimeType, ReducerContext};
<span class="kw">use </span>log::info;
<span class="kw">use </span>std::fmt;

<span class="attr">#[reducer]
</span><span class="kw">pub fn </span>hello_world(context: <span class="kw-2">&amp;</span>ReducerContext) {
    <span class="macro">info!</span>(<span class="string">"Hello, World!"</span>);
}

<span class="attr">#[reducer]
</span><span class="kw">pub fn </span>add_person(context: <span class="kw-2">&amp;</span>ReducerContext, name: String, age: u16) {
    <span class="comment">// add a "person" to the database.
</span>}

<span class="attr">#[derive(SpacetimeType, Debug)]
</span><span class="kw">struct </span>Coordinates {
    x: f32,
    y: f32,
}

<span class="kw">enum </span>AddPlaceError {
    InvalidCoordinates(Coordinates),
    InvalidName(String),
}

<span class="kw">impl </span>fmt::Display <span class="kw">for </span>AddPlaceError {
    <span class="kw">fn </span>fmt(<span class="kw-2">&amp;</span><span class="self">self</span>, f: <span class="kw-2">&amp;mut </span>fmt::Formatter&lt;<span class="lifetime">'_</span>&gt;) -&gt; <span class="prelude-ty">Result</span>&lt;(), fmt::Error&gt; {
        <span class="kw">match </span><span class="self">self </span>{
            AddPlaceError::InvalidCoordinates(coords) =&gt; {
                <span class="macro">write!</span>(f, <span class="string">"invalid coordinates: {coords:?}"</span>)
            },
            AddPlaceError::InvalidName(name) =&gt; {
                <span class="macro">write!</span>(f, <span class="string">"invalid name: {name:?}"</span>)
            },
        }
    }
}

<span class="attr">#[reducer]
</span><span class="kw">pub fn </span>add_place(
    context: <span class="kw-2">&amp;</span>ReducerContext,
    name: String,
    x: f32,
    y: f32,
    area: f32,
) -&gt; <span class="prelude-ty">Result</span>&lt;(), AddPlaceError&gt; {
    <span class="comment">// ... add a place to the database...
</span>}</code></pre></div>
<p>Reducers may fail by returning a <a href="https://doc.rust-lang.org/nightly/core/result/enum.Result.html" title="enum core::result::Result"><code>Result::Err</code></a> or by <a href="https://doc.rust-lang.org/nightly/std/macro.panic.html" title="macro std::panic">panicking</a>.
Failures will abort the active database transaction.
Any changes to the database made by the failed reducer call will be rolled back.</p>
<p>Reducers are limited in their ability to interact with the outside world.
They do not directly return data aside from errors, and have no access to any
network or filesystem interfaces.
Calling methods from <a href="https://doc.rust-lang.org/nightly/std/io/index.html" title="mod std::io"><code>std::io</code></a>, <a href="https://doc.rust-lang.org/nightly/std/net/index.html" title="mod std::net"><code>std::net</code></a>, or <a href="https://doc.rust-lang.org/nightly/std/fs/index.html" title="mod std::fs"><code>std::fs</code></a>
inside a reducer will result in runtime errors.</p>
<p>Reducers can communicate information to the outside world in two ways:</p>
<ul>
<li>They can modify tables in the database.
See the <code>#[table]</code>(#table) macro documentation for information on how to declare and use tables.</li>
<li>They can call logging macros from the <a href="https://docs.rs/log/0.4.27/x86_64-unknown-linux-gnu/log/index.html" title="mod log"><code>log</code></a> crate.
This writes to a private debug log attached to the database.
Run <code>spacetime logs &lt;DATABASE_IDENTITY&gt;</code> to browse these.</li>
</ul>
<p>Reducers are permitted to call other reducers, simply by passing their <code>ReducerContext</code> as the first argument.
This is a regular function call, and does not involve any network communication. The callee will run within the
caller’s transaction, and any changes made by the callee will be committed or rolled back with the caller.</p>
<h2 id="lifecycle-reducers"><a class="doc-anchor" href="#lifecycle-reducers">§</a>Lifecycle Reducers</h2>
<p>You can specify special lifecycle reducers that are run at set points in
the module’s lifecycle. You can have one of each per module.</p>
<p>These reducers cannot be called manually
and may not have any parameters except for <code>ReducerContext</code>.</p>
<h4 id="the-init-reducer"><a class="doc-anchor" href="#the-init-reducer">§</a>The <code>init</code> reducer</h4>
<p>This reducer is marked with <code>#[spacetimedb::reducer(init)]</code>. It is run the first time a module is published
and any time the database is cleared. (It does not have to be named <code>init</code>.)</p>
<p>If an error occurs when initializing, the module will not be published.</p>
<p>This reducer can be used to configure any static data tables used by your module. It can also be used to start running <a href="#scheduled-reducers">scheduled reducers</a>.</p>
<h4 id="the-client_connected-reducer"><a class="doc-anchor" href="#the-client_connected-reducer">§</a>The <code>client_connected</code> reducer</h4>
<p>This reducer is marked with <code>#[spacetimedb::reducer(client_connected)]</code>. It is run when a client connects to the SpacetimeDB module.
Their identity can be found in the sender value of the <code>ReducerContext</code>.</p>
<p>If an error occurs in the reducer, the client will be disconnected.</p>
<h4 id="the-client_disconnected-reducer"><a class="doc-anchor" href="#the-client_disconnected-reducer">§</a>The <code>client_disconnected</code> reducer</h4>
<p>This reducer is marked with <code>#[spacetimedb::reducer(client_disconnected)]</code>. It is run when a client disconnects from the SpacetimeDB module.
Their identity can be found in the sender value of the <code>ReducerContext</code>.</p>
<p>If an error occurs in the disconnect reducer,
the client is still recorded as disconnected.</p>
<h2 id="scheduled-reducers"><a class="doc-anchor" href="#scheduled-reducers">§</a>Scheduled reducers</h2>
<p>In addition to life cycle annotations, reducers can be made <strong>scheduled</strong>.
This allows calling the reducers at a particular time, or in a loop.
This can be used for game loops.</p>
<p>The scheduling information for a reducer is stored in a table.
This table has two mandatory fields:</p>
<ul>
<li>A primary key that identifies scheduled reducer calls.</li>
<li>A <a href="enum.ScheduleAt.html" title="enum spacetimedb::ScheduleAt"><code>ScheduleAt</code></a> field that says when to call the reducer.</li>
</ul>
<p>Managing timers with a scheduled table is as simple as inserting or deleting rows from the table.
This makes scheduling transactional in SpacetimeDB. If a reducer A first schedules B but then errors for some other reason, B will not be scheduled to run.</p>
<p>A <a href="enum.ScheduleAt.html" title="enum spacetimedb::ScheduleAt"><code>ScheduleAt</code></a> can be created from a <a href="struct.Timestamp.html" title="struct spacetimedb::Timestamp"><code>spacetimedb::Timestamp</code></a>, in which case the reducer will be scheduled once,
or from a <a href="https://doc.rust-lang.org/nightly/core/time/struct.Duration.html" title="struct core::time::Duration"><code>std::time::Duration</code></a>, in which case the reducer will be scheduled in a loop. In either case the conversion can be performed using <a href="https://doc.rust-lang.org/nightly/core/convert/trait.Into.html#tymethod.into" title="method core::convert::Into::into"><code>Into::into</code></a>.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>spacetimedb::{table, reducer, ReducerContext, Timestamp, TimeDuration, ScheduleAt, Table};
<span class="kw">use </span>log::debug;

<span class="comment">// First, we declare the table with scheduling information.

</span><span class="attr">#[table(name = send_message_schedule, scheduled(send_message))]
</span><span class="kw">struct </span>SendMessageSchedule {
    <span class="comment">// Mandatory fields:
    // ============================

    </span><span class="doccomment">/// An identifier for the scheduled reducer call.
    </span><span class="attr">#[primary_key]
    #[auto_inc]
    </span>scheduled_id: u64,

    <span class="doccomment">/// Information about when the reducer should be called.
    </span>scheduled_at: ScheduleAt,

    <span class="comment">// In addition to the mandatory fields, any number of fields can be added.
    // These can be used to provide extra information to the scheduled reducer.

    // Custom fields:
    // ============================

    </span><span class="doccomment">/// The text of the scheduled message to send.
    </span>text: String,
}

<span class="comment">// Then, we declare the scheduled reducer.
// The first argument of the reducer should be, as always, a `&amp;ReducerContext`.
// The second argument should be a row of the scheduling information table.

</span><span class="attr">#[reducer]
</span><span class="kw">fn </span>send_message(ctx: <span class="kw-2">&amp;</span>ReducerContext, arg: SendMessageSchedule) -&gt; <span class="prelude-ty">Result</span>&lt;(), String&gt; {
    <span class="kw">let </span>message_to_send = arg.text;

    <span class="comment">// ... send the message ...

    </span><span class="prelude-val">Ok</span>(())
}

<span class="comment">// Now, we want to actually start scheduling reducers.
// It's convenient to do this inside the `init` reducer.
</span><span class="attr">#[reducer(init)]
</span><span class="kw">fn </span>init(ctx: <span class="kw-2">&amp;</span>ReducerContext) {

    <span class="kw">let </span>current_time = ctx.timestamp;

    <span class="kw">let </span>ten_seconds = TimeDuration::from_micros(<span class="number">10_000_000</span>);

    <span class="kw">let </span>future_timestamp: Timestamp = ctx.timestamp + ten_seconds;
    ctx.db.send_message_schedule().insert(SendMessageSchedule {
        scheduled_id: <span class="number">1</span>,
        text:<span class="string">"I'm a bot sending a message one time"</span>.to_string(),

        <span class="comment">// Creating a `ScheduleAt` from a `Timestamp` results in the reducer
        // being called once, at exactly the time `future_timestamp`.
        </span>scheduled_at: future_timestamp.into()
    });

    <span class="kw">let </span>loop_duration: TimeDuration = ten_seconds;
    ctx.db.send_message_schedule().insert(SendMessageSchedule {
        scheduled_id: <span class="number">0</span>,
        text:<span class="string">"I'm a bot sending a message every 10 seconds"</span>.to_string(),

        <span class="comment">// Creating a `ScheduleAt` from a `Duration` results in the reducer
        // being called in a loop, once every `loop_duration`.
        </span>scheduled_at: loop_duration.into()
    });
}</code></pre></div>
<p>Scheduled reducers are called on a best-effort basis and may be slightly delayed in their execution
when a database is under heavy load.</p>
<h4 id="restricting-scheduled-reducers"><a class="doc-anchor" href="#restricting-scheduled-reducers">§</a>Restricting scheduled reducers</h4>
<p>Scheduled reducers are normal reducers, and may still be called by clients.
If a scheduled reducer should only be called by the scheduler,
consider beginning it with a check that the caller <code>Identity</code> is the module:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>spacetimedb::{reducer, ReducerContext};


<span class="attr">#[reducer]
</span><span class="kw">fn </span>scheduled(ctx: <span class="kw-2">&amp;</span>ReducerContext, args: ScheduledArgs) -&gt; <span class="prelude-ty">Result</span>&lt;(), String&gt; {
    <span class="kw">if </span>ctx.sender != ctx.identity() {
        <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">"Reducer `scheduled` may not be invoked by clients, only via scheduling."</span>.into());
    }
    <span class="comment">// Reducer body...
</span>}</code></pre></div>
<!-- TODO: SLAs? -->
</div></details></section></div></main></div></body>
<!-- Mirrored from docs.rs/spacetimedb/latest/spacetimedb/attr.reducer.html by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 10 May 2025 00:22:25 GMT -->
</html>